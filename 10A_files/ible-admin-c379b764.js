Ibles.models.CategoryChannelModel=Backbone.Model.extend({defaults:{category:null,channel:null,displayChannel:null,categoriesList:null},initialize:function(){if(_.isNull(this.get("categoriesList"))){this.getCategoriesAndChannels()}else{this.trigger("categoriesLoaded")}var category=this.get("category"),channel=this.get("channel");if(channel&&_.isNull(this.get("displayChannel"))){this.set("displayChannel",this.getCurrentChannelDisplayName(category,channel))}},getCategoriesAndChannels:function(){var that=this;Ibles.API.getRequest("getCategories",{},{success:function(data){that.set({categoriesList:data});that.trigger("categoriesLoaded")},error:function(){}})},getCurrentChannelDisplayName:function(category,channel){var channelArray=this.get("categoriesList")[category];var channelObj=_.findWhere(channelArray,{title:channel});return channelObj?channelObj.display:""},updateCategoryAndChannel:function(category,channel){this.set({category:category,channel:channel,displayChannel:this.getCurrentChannelDisplayName(category,channel)})}});Ibles.package("Ibles.views");Ibles.views.CategoryChannelDropdownView=Backbone.View.extend({events:{"change .edit-category":"setCategory","change .channelDropdown":"setChannel"},template:_.template($("#categoryChannelTemplate").html()),initialize:function(){if(!_.isNull(this.model.get("categoriesList"))){this.render()}this.listenTo(this.model,"categoriesLoaded",this.render);this.listenTo(this.model,"change:channel",this.updateChannel)},render:function(){var categoryChannelWrapper=this.$el,currentCategory=this.model.get("category"),currentChannel=this.model.get("channel"),currentDisplayChannel=this.model.get("displayChannel"),categories,categoryDropdown,channelWrapper,that=this;categoryChannelWrapper.html(this.template());categories=this.model.get("categoriesList");categoryDropdown=this.$(".edit-category");channelWrapper=this.$(".channel-wrapper");_.each(categories,function(channels,catName){var categoryChannelName=catName+"-channels",channelDropdown;categoryDropdown.append($("<option></option>").attr("name",catName).text(catName));channelWrapper.append($("<select></select>").attr({name:categoryChannelName}).addClass(categoryChannelName).addClass("channelDropdown"));channelDropdown=that.$("."+categoryChannelName);that.createChannelDropdown(channelDropdown,channels);if(currentCategory!==null){that.$(".channel-edit-placeholder").hide()}if(currentCategory!==catName){channelDropdown.hide()}else{categoryDropdown.val(currentCategory);if(!_.isUndefined(currentChannel)){channelDropdown.val(currentDisplayChannel)}}})},createChannelDropdown:function(channelDropdown,channels){channelDropdown.append($("<option></option>").attr({name:"channel",disabled:true}).text("Channel"));_.each(channels,function(ch){channelDropdown.append($("<option></option>").attr("name",ch.title).text(ch.display))})},setCategory:function(){var categoryDropdown=this.$(".edit-category"),currentCategory=this.model.get("category"),newCategory=categoryDropdown.find(":selected").attr("name");if(currentCategory===null){this.$(".channel-edit-placeholder").hide()}else{this.$("."+currentCategory+"-channels").hide()}this.$("."+newCategory+"-channels").show();this.model.set({category:newCategory});this.setChannel()},setChannel:function(){var channelSelect=this.$("."+this.model.get("category")+"-channels"),newChannel=channelSelect.find(":selected").attr("name"),newDisplayChannel=channelSelect.val();this.model.set({channel:newChannel});this.model.set({displayChannel:newDisplayChannel})},updateChannel:function(model){var categoryDropdown=this.$(".edit-category"),newCategory=this.model.get("category"),oldCategory=categoryDropdown.find(":selected").attr("name");var channelSelect=this.$("."+oldCategory+"-channels"),newChannel=this.model.get("channel"),oldChannel=channelSelect.find(":selected").attr("name");if(oldCategory!==newCategory||oldChannel!==newChannel){this.render()}}});Ibles.package("Ibles.views","Ibles.models");Ibles.models.AdminCategoryChannelModel=Ibles.models.CategoryChannelModel.extend({defaults:{id:null,type:"instructable",category:null,channel:null,categoriesList:null},save:function(){var self=this;this.trigger("updating");return $.ajax({url:"/edit/categoryChannel/",data:{entryId:this.get("id"),type:this.get("type"),category:this.get("category"),channel:this.get("channel")},type:"POST",success:function(data){self.trigger("reset","success")},error:function(){self.trigger("reset","error")}})}});Ibles.views.AdminCategoryChannelChanger=Backbone.View.extend({template:_.template($("#admin-category-channel-template").html()),events:{"click .submit-btn":"submit"},initialize:function(options){this.listenTo(this.model,"updating",this.showLoadingState);this.listenTo(this.model,"reset",this.reset);this.render=_.once(this.render);this.render()},showLoadingState:function(){this.$(".btn").button("loading")},reset:function(){var $btn=this.$(".btn");$btn.button("complete");setTimeout(function(){$btn.button("reset")},1e3)},submit:function(e){this.model.save()},render:function(){this.$el.html(this.template(this.model.toJSON()));new Ibles.views.CategoryChannelDropdownView({model:this.model,el:this.$("#admin-category-channel-selector")})}});Ibles.package("Ibles.views","Ibles.models");Ibles.models.FeatureModel=Backbone.Model.extend({defaults:{id:null,type:null,featured:false,featuredDate:null,featuredHomePage:false,featuredHomePageDate:null},save:function(featureFlag,isHomepageFeature){var self=this,params={entryID:this.get("id"),type:"instructable",addToQueue:featureFlag?"checked":"unchecked"};params[isHomepageFeature?"featureHomePage":"feature"]=featureFlag?"checked":"unchecked";this.trigger("updating",params);return Ibles.API.ajaxRequest("feature",params,{success:function(data){if(isHomepageFeature){self.set({featuredHomePage:featureFlag});self.set({featuredHomePageDate:data.homePageFeaturedDate})}else{self.set({featured:featureFlag});self.set({featuredDate:data.featuredDate})}self.trigger("reset","success")},error:function(){self.trigger("reset","error")}})}});Ibles.views.FeatureView=Backbone.View.extend({events:{"click .feature-btn":"feature","click .feature-hp-btn":"featureForHomepage","click .unfeature-btn":"unfeature","click .unfeature-hp-btn":"unfeatureForHomepage"},$currentTarget:null,initialize:function(options){this.template=options.template;this.listenTo(this.model,"updating",this.showLoadingState);this.listenTo(this.model,"reset",this.render);this.render()},feature:function(e){this.$currentTarget=$(e.currentTarget);this.model.save(true,false)},featureForHomepage:function(e){this.$currentTarget=$(e.currentTarget);this.model.save(true,true)},unfeature:function(e){this.$currentTarget=$(e.currentTarget);this.model.save(false,false)},unfeatureForHomepage:function(e){this.$currentTarget=$(e.currentTarget);this.model.save(false,true)},showLoadingState:function(data){this.$currentTarget.html(this.$(".admin-feature-module").data("loading-txt"))},render:function(lastAttemptStatus){this.$el.html(this.template(_.extend(this.model.toJSON(),{lastAttemptStatus:lastAttemptStatus})));this.$(".alert-"+lastAttemptStatus).fadeOut(3e3);return this}});Ibles.package("Ibles.views","Ibles.models");Ibles.models.AdminLocaleChangerModel=Backbone.Model.extend({defaults:{id:null,locale:"en_US"},save:function(e){var self=this;return $.ajax({url:"/ajax/locale/",type:"POST",dataType:"json",data:{id:this.get("id"),locale:this.get("locale")}})}});Ibles.views.AdminLocaleChanger=Backbone.View.extend({template:_.template($("#admin-locale-changer-template").html()),events:{"click .submit-btn":"submit","change .locale-selector":"setLocale"},initialize:function(options){this.render()},setLocale:function(e){this.model.set({locale:$(e.currentTarget).val()})},submit:function(e){var $btn=this.$(".btn");$btn.button("loading");this.model.save().always(function(){$btn.button("complete");setTimeout(function(){$btn.button("reset")},1e3)})},render:function(){this.$el.html(this.template(this.model.toJSON()));this.$('.locale-selector option[value="'+this.model.get("locale")+'"]').prop("selected",true)}});Ibles.package("Ibles.views","Ibles.models");Ibles.models.KeywordTaggerModel=Backbone.Model.extend({defaults:function(){return{id:null,type:"INSTRUCTABLE",keywords:[]}},add:function(keywordString){var self=this;return this.sync("ADD",keywordString).done(function(data){if(!_.isEmpty(data)){self.set({keywords:self.get("keywords").slice(0).concat(data)});self.trigger("reset","success")}})},"delete":function(keywordString){var self=this;return this.sync("DELETE",keywordString).done(function(data){if(!_.isEmpty(data)){self.set({keywords:data});self.trigger("reset","success")}})},deleteAll:function(){var self=this;return this.sync("DELETE_ALL").done(function(){self.set({keywords:[]});self.trigger("reset","success")})},sync:function(action,keywordString){var self=this,params={entryID:this.get("id"),type:this.get("type"),action:action};if(keywordString){params["word"]=keywordString}this.trigger("updating",params);return $.ajax({url:"/ajax/tag/",dataType:"json",data:params,error:function(jqxhr){self.trigger("reset","success")}})}});Ibles.views.AdminKeywordTagger=Backbone.View.extend({template:_.template($("#admin-keyword-tagger-template").html()),events:{"click .remove-keyword":"remove","click .remove-all-link":"removeAll","keypress .new-keyword-field":"add"},initialize:function(options){this.listenTo(this.model,"updating",this.showLoadingState);this.listenTo(this.model,"reset",this.render);this.render()},add:function(e){if(e.keyCode===13){e.preventDefault();var keywords=$(e.currentTarget).val();if(!_.isEmpty(keywords)){this.model.add(keywords)}}},remove:function(e){this.model.delete($(e.currentTarget).data("keyword"))},removeAll:function(e){var self=this;new Ibles.views.ConfirmationView({model:new Ibles.models.ConfirmationModel({confirmationMessage:"Are you sure?"}),callbackFn:function(){self.model.deleteAll();return true}})},showLoadingState:function(data){this.$(".icon-spinner").show()},render:function(lastAttemptStatus){this.$el.html(this.template(_.extend(this.model.toJSON(),{lastAttemptStatus:lastAttemptStatus})));if(lastAttemptStatus){this.$(".alert-"+lastAttemptStatus).fadeOut(3e3);this.$(".new-keyword-field").focus()}return this}});Ibles.package("Ibles.views","Ibles.models");Ibles.models.StatusModel=Backbone.Model.extend({defaults:function(){return{id:null,status:null,typeChar:null,publishedDate:null,quarantineReasons:[],quarantineComments:[]}},publishStatuses:["UNPUBLISHED","PRIVATE","PUBLISHED","QUARANTINED","LIMBO","DELETED"],updateStatus:function($form){var formData=$form.serialize(),formAction=$form.attr("action"),serverSideAction=Ibles.getUrlParam(formData,"action")||Ibles.getUrlParam(formData,"updateAction"),self=this;this.trigger("updating");return $.ajax({type:"POST",url:$form.attr("action"),data:formData,success:function(response){if(serverSideAction==="PUBLISH"||serverSideAction==="PUBLISH_NOW"){self.set({status:"PUBLISHED"})}self.trigger("reset","success");if(self.get("status")==="QUARANTINED")self.fetchQuarantineReasons()},error:function(jqXhr){self.trigger("reset","error")}})},fetchQuarantineReasons:function(){var self=this;$.ajax({url:"/json-api/showInstructableUserData",cache:false,data:{id:this.get("id")},success:function(data){if(!_.isEmpty(data.quarantineReasons)){self.setQuarantineReasons(data.quarantineReasons)}}})},setQuarantineReasons:function(quarantineReasons){this.set({quarantineReasons:quarantineReasons});this.trigger("change:quarantineReasons")},setQuarantineComments:function(quarantineComments){this.set({quarantineComments:CSVToObjects(quarantineComments)});this.trigger("change:quarantineComments")},toJSON:function(){var json=Backbone.Model.prototype.toJSON.apply(this,arguments);json["publishStatuses"]=this.publishStatuses;return json}});Ibles.views.AdminStatusManager=Backbone.View.extend({template:_.template($("#admin-status-manager-template").html()),quarantineReasonsTemplate:_.template($("#admin-quarantine-reasons-template").html()),quarantineCommentsTemplate:_.template($("#admin-quarantine-comments-template").html()),events:{"click .submit-btn":"submit","change .quarantine-comments-dropdown":"quarantineCommentSelected","change .ible-status-dropdown":"ibleStatusSelected"},initialize:function(options){this.listenTo(this.model,"reset",this.render);this.listenTo(this.model,"change:quarantineReasons",this.renderQuarantineReasons);this.listenTo(this.model,"change:quarantineComments",this.renderQuarantineComments);this.render()},ibleStatusSelected:function(e){this.model.set({status:$(e.currentTarget).val()})},quarantineCommentSelected:function(e){var selectedValue=$(e.currentTarget).val();if(selectedValue==="none"){this.disableQuarantineComment()}else{this.enableQuarantineComment();this.setCannedQuarantineComment()}},disableQuarantineComment:function(){this.$('textarea[name="quarantineMessage"]').val("");this.$('select[name="action"]').val(this.$('select[name="action"]').data("initialstatus")).change();this.$('select[name="action"]').prop("disabled",false).removeClass("disabled");this.$('form[name="ManageFlagsForm"] .submit-btn').prop("disabled",false).removeClass("disabled");this.$('form[name="QuarantineCommentForm"] .submit-btn').prop("disabled","disabled").addClass("disabled")},enableQuarantineComment:function(){this.$('select[name="action"]').val("UNPUBLISHED").change();this.$('select[name="action"]').prop("disabled","disabled").addClass("disabled");this.$('form[name="ManageFlagsForm"] .submit-btn').prop("disabled","disabled").addClass("disabled");this.$('form[name="QuarantineCommentForm"] .submit-btn').prop("disabled",false).removeClass("disabled")},setCannedQuarantineComment:function(){var commentBody=this.model.get("quarantineComments")[this.$('select[name="quarantineCommentsSelect"] option:selected').data("commentindex")]["body"];this.$('textarea[name="quarantineMessage"]').val(commentBody)},submit:function(e){e.preventDefault();var $btn=$(e.currentTarget);$btn.button("loading");this.model.updateStatus($btn.closest("form"))},renderQuarantineReasons:function(){this.$(".quarantine-reasons-container").html(this.quarantineReasonsTemplate(this.model.toJSON()))},renderQuarantineComments:function(){this.$(".quarantine-comments-container").html(this.quarantineCommentsTemplate(this.model.toJSON()))},render:function(lastAttemptStatus){this.$el.html(this.template(_.extend(this.model.toJSON(),{lastAttemptStatus:lastAttemptStatus})));this.$(".alert-"+lastAttemptStatus).fadeOut(3e3);this.renderQuarantineReasons();this.renderQuarantineComments();return this}});Ibles.package("Ibles.views","Ibles.models");Ibles.models.PendingContestsModel=Backbone.Model.extend({initialize:function(){this.pendingContests=new Backbone.Collection(this.get("pendingContests"));this.unset("pendingContests",{silent:true})},acceptContest:function(contestId){this.pendingContests.get(contestId).set({state:"accept"})},denyContest:function(contestId){this.pendingContests.get(contestId).set({state:"deny"})},prunePendingContestList:function(){this.pendingContest;this.pendingContests.each(function(pendingContest){pendingContest.set({state:null})})},save:function(){var self=this,params={instructableId:this.get("id"),updateAction:"PENDING_CONTESTS",destUrl:Ibles.reverseUrls.ibleUrl(this.get("id"))},contestParams=this.getPendingContestsParams();if(_.isEmpty(contestParams))return;params=_.extend(params,contestParams);this.trigger("updating");Ibles.API.adminAjaxRequest("omniUpdater",params).done(function(){self.pendingContests.reset(self.getUnupdatedContestsModels());self.trigger("reset","success")}).fail(function(){self.trigger("reset","error")})},getPendingContestsParams:function(){var params={};this.pendingContests.each(function(pendingContest){var state=pendingContest.get("state"),key="contest-"+pendingContest.get("id");if(!_.isEmpty(state)){params[key]=state}});return params},getUnupdatedContestsModels:function(){return _.reduce(this.pendingContests.toArray(),function(memo,pendingContest){var state=pendingContest.get("state"),key="contest-"+pendingContest.get("id");if(_.isEmpty(state)){memo.push(pendingContest)}return memo},[])},toJSON:function(){var json=Backbone.Model.prototype.toJSON.apply(this,arguments);json.pendingContests=this.pendingContests.toJSON();return json}});Ibles.views.AdminContestModerator=Backbone.View.extend({template:_.template($("#admin-contest-moderation-template").html()),events:{"click .submit-btn":"submit",'click input[type="radio"]':"selectPendingContest"},initialize:function(options){this.listenTo(this.model,"updating",this.showLoadingState);this.listenTo(this.model,"reset",this.render);this.render()},selectPendingContest:function(e){var $input=$(e.currentTarget),contestId=$input.data("contestid"),val=$input.val();switch(val){case"accept":this.model.acceptContest(contestId);break;case"deny":this.model.denyContest(contestId);break}},submit:function(e){e.preventDefault();this.model.save()},showLoadingState:function(){this.$(".btn").button("loading")},render:function(lastAttemptStatus){this.$el.html(this.template(this.model.toJSON()));return this}});Ibles.package("Ibles.views","Ibles.models");Ibles.models.AdminFlagsModel=Backbone.Model.extend({initialize:function(){this.flags=new Backbone.Collection(this.get("flags"));this.unset("flags",{silent:true})},clearAll:function(){var self=this,params={instructableId:this.get("id"),updateAction:"CLEAR_ALL_FLAGS",destUrl:Ibles.reverseUrls.ibleUrl(this.get("id"))};this.trigger("updating");Ibles.API.adminAjaxRequest("omniUpdater",params).done(function(){self.flags.reset([]);self.trigger("reset","success")}).fail(function(){self.trigger("reset","error")})},toJSON:function(){var json=Backbone.Model.prototype.toJSON.apply(this,arguments);json.flags=this.flags.toJSON();return json}});Ibles.views.AdminFlagsManager=Backbone.View.extend({template:_.template($("#admin-manage-flags-template").html()),events:{"click .clear-btn":"clearAllFlags"},initialize:function(options){this.listenTo(this.model,"updating",this.showLoadingState);this.listenTo(this.model,"reset",this.render);this.render()},clearAllFlags:function(e){e.preventDefault();this.model.clearAll()},showLoadingState:function(){this.$(".clear-btn").button("loading")},render:function(lastAttemptStatus){this.$el.html(this.template(this.model.toJSON()));return this}});Ibles.package("Ibles.views","Ibles.models");Ibles.models.AdminIbleAttributesModel=Backbone.Model.extend({defaults:{isApproved:false,pgFlag:false,sponsoredFlag:false,fullAccessFlag:false,commentingEnabled:false,pdfBackupMade:false},toggleApproved:function(){this.set({isApproved:!this.get("isApproved")});this.send("/ajax/approve/",{entryID:this.get("id"),status:this.get("isApproved")?"CHECKED":"UNCHECKED"})},togglePgFlag:function(){this.set({pgFlag:!this.get("pgFlag")});this.send("/edit/pgFlag/",{instructableId:this.get("id"),pgFlag:this.get("pgFlag")})},toggleSponsoredFlag:function(){this.set({sponsoredFlag:!this.get("sponsoredFlag")});this.send("/edit/sponsoredFlag/",{instructableId:this.get("id"),sponsoredFlag:this.get("sponsoredFlag")})},toggleFullAccess:function(){this.set({fullAccessFlag:!this.get("fullAccessFlag")});this.send("/edit/fullAccessFlag/",{entryId:this.get("id"),fullAccess:this.get("fullAccessFlag")})},toggleComments:function(){this.set({commentingEnabled:!this.get("commentingEnabled")});this.send("/edit/enableCommenting/",{entryId:this.get("id"),commentingEnabled:this.get("commentingEnabled")})},togglePdfBackup:function(){this.set({pdfBackupMade:!this.get("pdfBackupMade")});this.send("/edit/schedulePdfBackup/",{entryId:this.get("id")})},resetUrl:function(){this.send("/edit/resetURL/",{categoryString:"instructable",entryId:this.get("id")})},send:function(url,params){var self=this;this.trigger("updating");return $.ajax({url:url,data:params,type:"POST",success:function(data){self.trigger("reset","success")},error:function(){self.trigger("reset","error")}})}});Ibles.views.AdminIbleAttributesPanel=Backbone.View.extend({template:_.template($("#admin-attributes-panel-template").html()),events:{"click .reset-url-btn":"resetUrl","click .approved-cb":"toggleApproved","click .pg-flag-cb":"togglePgFlag","click .sponsored-cb":"toggleSponsoredFlag","click .full-access-cb":"toggleFullAccess","click .enable-comments-cb":"toggleComments","click .backup-pdf-cb":"togglePdfBackup"},initialize:function(options){this.listenTo(this.model,"updating",this.showLoadingState);this.listenTo(this.model,"reset",this.render);this.render()},resetUrl:function(e){this.model.resetUrl()},toggleApproved:function(e){this.model.toggleApproved()},togglePgFlag:function(e){this.model.togglePgFlag()},toggleSponsoredFlag:function(e){this.model.toggleSponsoredFlag()},toggleFullAccess:function(e){this.model.toggleFullAccess()},toggleComments:function(e){this.model.toggleComments()},togglePdfBackup:function(e){this.model.togglePdfBackup()},showLoadingState:function(data){this.$(".icon-spinner").show()},render:function(lastAttemptStatus){this.$el.html(this.template(_.extend(this.model.toJSON(),{lastAttemptStatus:lastAttemptStatus})));if(lastAttemptStatus){this.$(".alert-"+lastAttemptStatus).fadeOut(3e3)}return this}});Ibles.package("Ibles.views","Ibles.models");Ibles.models.AdminReviewModel=Backbone.Model.extend({defaults:{id:null,reviewState:null,reviewerScreenName:null,reviewedDate:null},claimIt:function(){var self=this,params={updateAction:"SET_REVIEWER",instructableId:this.get("id"),destUrl:Ibles.reverseUrls.ibleUrl(this.get("id"))};this.trigger("updating");Ibles.API.adminAjaxRequest("omniUpdater",params).done(function(){self.set({reviewState:"IN_PROGRESS",reviewerScreenName:Ibles.session.get("screenName"),reviewedDate:moment().format()});self.trigger("reset","success")}).fail(function(){self.trigger("reset","error")})},markComplete:function(){var self=this,params={action:"TOGGLE_STATES"};params["stateChange-"+this.get("id")]="COMPLETED";this.trigger("updating");return Ibles.API.adminAjaxRequest("contentViewer",params).done(function(){self.set({reviewState:"COMPLETED",reviewDate:moment().format()});self.trigger("reset","success")}).fail(function(){self.trigger("reset","error")})}});Ibles.views.AdminReviewModule=Backbone.View.extend({template:_.template($("#admin-review-module-template").html()),events:{"click .claim-btn":"claimIt","click .mark-complete-btn":"markComplete"},initialize:function(options){this.listenTo(this.model,"updating",this.showLoadingState);this.listenTo(this.model,"reset",this.render);this.render()},claimIt:function(e){e.preventDefault();this.model.claimIt()},markComplete:function(e){e.preventDefault();this.model.markComplete().done(function(){$(".admin-attributes-module input.approved-cb").prop("checked",true)})},render:function(lastAttemptStatus){this.$el.html(this.template(_.extend(this.model.toJSON(),{lastAttemptStatus:lastAttemptStatus,screenName:Ibles.session.get("screenName")})));this.$(".alert-"+lastAttemptStatus).fadeOut(3e3);return this}});Ibles.package("Ibles.views","Ibles.models");Ibles.models.AdminLicenseChangerModel=Backbone.Model.extend({defaults:{id:null,currentLicense:""},initialize:function(options){this.licenses=window.Ibles.licenses;if(options.license)this.set("currentLicense",this.getShortName(options.license.fullName))},getShortName:function(fullName){return _.find(this.licenses,function(license){return license[1]===fullName})[0]},getLicenseParam:function(){return this.get("currentLicense").toUpperCase().replace("-","_")},save:function(e){return $.ajax({url:"/edit/license/",type:"POST",data:{posted:(new Date).getTime(),instructableId:this.get("id"),license:this.getLicenseParam()}})}});Ibles.views.AdminLicenseChanger=Backbone.View.extend({template:_.template($("#admin-license-changer-template").html()),events:{"click .submit-btn":"submit","change .license-selector":"setLicense"},initialize:function(options){this.render()},setLicense:function(e){this.model.set({currentLicense:$(e.currentTarget).val()})},submit:function(e){var $btn=this.$(".btn");$btn.button("loading");this.model.save().always(function(){$btn.button("complete");setTimeout(function(){$btn.button("reset")},1e3)})},render:function(){this.$el.html(this.template(this.model.toJSON()))}});function CSVtoArray(text){var re_valid=/^\s*(?:'[^'\\]*(?:\\[\S\s][^'\\]*)*'|"[^"\\]*(?:\\[\S\s][^"\\]*)*"|[^,'"\s\\]*(?:\s+[^,'"\s\\]+)*)\s*(?:,\s*(?:'[^'\\]*(?:\\[\S\s][^'\\]*)*'|"[^"\\]*(?:\\[\S\s][^"\\]*)*"|[^,'"\s\\]*(?:\s+[^,'"\s\\]+)*)\s*)*$/;var re_value=/(?!\s*$)\s*(?:'([^'\\]*(?:\\[\S\s][^'\\]*)*)'|"([^"\\]*(?:\\[\S\s][^"\\]*)*)"|([^,'"\s\\]*(?:\s+[^,'"\s\\]+)*))\s*(?:,|$)/g;if(!re_valid.test(text))return null;var a=[];text.replace(re_value,function(m0,m1,m2,m3){if(m1!==undefined)a.push(m1.replace(/\\'/g,"'"));else if(m2!==undefined)a.push(m2.replace(/\\"/g,'"'));else if(m3!==undefined)a.push(m3);return""});if(/,\s*$/.test(text))a.push("");return a}function CSVToObjects(text){var firstIndexOfNewline=text.indexOf("\n"),columns=text.substring(0,firstIndexOfNewline).trim().split(",").map(Function.prototype.call,String.prototype.trim),csvArray=[],objArray=[],columnCount=columns.length;text=text.substring(firstIndexOfNewline);text=text.replace(/(^\n+|\n+$)/g,"");var temp=text;text=text.replace(/\n/g,function(match,index){var quotes=(temp.substring(0,index).match(/"/g)||[]).length,escapedQuotes=(temp.substring(0,index).match(/\\"/g)||[]).length;if((quotes-escapedQuotes)%2===0){return","+match}return match});text=text.replace(/'/g,function(match,index){var quotes=(temp.substring(0,index).match(/"/g)||[]).length,escapedQuotes=(temp.substring(0,index).match(/\\"/g)||[]).length;if((quotes-escapedQuotes)%2===0){return"&#39;"}return match});csvArray=CSVtoArray(text);for(var i=0;i<csvArray.length;i=i+columnCount){var obj={};for(var j=0;j<columnCount;j++){var csvData=csvArray[i+j];if(typeof csvData==="undefined")return objArray;obj[columns[j]]=csvData}objArray.push(obj)}return objArray}Ibles.package("Ibles.models","Ibles.views");Ibles.views.Admin=Backbone.View.extend({panelTemplate:_.template($("#admin-panel-template").html()),events:{"click .collapse-btn":"toggleAdminPanel"},initialize:function(opts){var self=this;var adminIbleRequest=$.ajax({url:"/json-api/showInstructableUserData",data:{id:Ibles.pageContext.ibleData.id},success:function(data){_.extend(Ibles.pageContext.ibleData,data);self.render()}})},toggleAdminPanel:function(e){$(e.currentTarget).closest(".admin-panel").toggleClass("collapsed")},createPanel:function(title,collapsible){return $(this.panelTemplate({title:title,collapsible:collapsible}))},render:function(){this.$el.empty();if(Ibles.session.isAdmin()){this.renderAdminPanel();this.renderAuthorPanel()}else if(Ibles.session.isStaff()){this.renderStaffPanel()}else if(Ibles.session.get("id")===Ibles.pageContext.ibleData.author.id){this.renderAuthorPanel()}this.$el.show()},renderAdminPanel:function(){var $panel=this.createPanel(Ibles.T("Admin"));this.renderFeatureView($panel);this.renderReviewModule($panel);this.renderAttributesPanel($panel);this.renderStatusManager($panel);this.renderContestModerator($panel);this.renderFlagsManager($panel);this.renderCategoryChannelChanger($panel);this.renderKeywordTagger($panel);this.renderLocaleChanger($panel);this.$el.append($panel)},renderStaffPanel:function(){var $panel=this.createPanel(Ibles.T("Staff"));this.renderFeatureView($panel);this.renderCategoryChannelChanger($panel);this.renderKeywordTagger($panel);this.renderLocaleChanger($panel);this.$el.append($panel)},renderAuthorPanel:function(){var $panel=this.createPanel(Ibles.T("Author"),true),$editIbleBtn=$('<a class="btn btn-mini pull-right">');$editIbleBtn.html(Ibles.T("Edit Instructable"));$editIbleBtn.attr("href",Ibles.reverseUrls.ibleEditUrl(Ibles.pageContext.ibleData.id));$panel.find(".admin-header").append($editIbleBtn);this.renderCategoryChannelChanger($panel);this.renderKeywordTagger($panel);this.renderLocaleChanger($panel);this.renderLicenseChanger($panel);this.$el.append($panel)},renderFeatureView:function($panel){var ibleData=Ibles.pageContext.ibleData;var featureData={id:ibleData.id,type:"instructable",featured:ibleData.featureFlag,featuredDate:ibleData.featuredDate,featuredHomePage:ibleData.homePageFeatureFlag,featuredHomePageDate:ibleData.homePageFeaturedDate};var featureView=new Ibles.views.FeatureView({className:"admin-feature-container",model:new Ibles.models.FeatureModel(featureData),session:Ibles.session,template:_.template($("#admin-feature-template").html())});$panel.append(featureView.$el);if(ibleData.type!=="Guide"){var homePageFeatureView=new Ibles.views.FeatureView({className:"admin-home-feature-container",model:new Ibles.models.FeatureModel(featureData),session:Ibles.session,template:_.template($("#admin-home-feature-template").html())});$panel.append(homePageFeatureView.$el)}},renderCategoryChannelChanger:function($panel){var ibleData=Ibles.pageContext.ibleData;var categoryChannelChanger=new Ibles.views.AdminCategoryChannelChanger({className:"admin-category-channel-container",model:new Ibles.models.AdminCategoryChannelModel({id:ibleData.id,type:"instructable",category:ibleData.category,channel:ibleData.channel,displayChannel:ibleData.displayChannel})});$panel.append(categoryChannelChanger.$el)},renderLocaleChanger:function($panel){var ibleData=Ibles.pageContext.ibleData;var localeChanger=new Ibles.views.AdminLocaleChanger({className:"admin-locale-changer-container",model:new Ibles.models.AdminLocaleChangerModel({id:ibleData.id,locale:ibleData.locale})});$panel.append(localeChanger.$el)},renderLicenseChanger:function($panel){var ibleData=Ibles.pageContext.ibleData;var licenseChanger=new Ibles.views.AdminLicenseChanger({className:"admin-license-changer-container",model:new Ibles.models.AdminLicenseChangerModel({id:ibleData.id,license:ibleData.license,licenses:window.Ibles.licenses})});$panel.append(licenseChanger.$el)},renderKeywordTagger:function($panel){var ibleData=Ibles.pageContext.ibleData;var keywordTagger=new Ibles.views.AdminKeywordTagger({className:"admin-keyword-tagger-container",model:new Ibles.models.KeywordTaggerModel({id:ibleData.id,type:"INSTRUCTABLE",keywords:ibleData.keywords||[]})});$panel.append(keywordTagger.$el)},renderStatusManager:function($panel){var ibleData=Ibles.pageContext.ibleData;var statusManager=new Ibles.views.AdminStatusManager({className:"admin-status-manager-container",model:new Ibles.models.StatusModel({id:ibleData.id,status:ibleData.status,publishedDate:ibleData.publishDate,typeChar:ibleData.typeChar,quarantineReasons:ibleData.quarantineReasons})});$panel.append(statusManager.$el);var adminCsvRequest=$.ajax({url:"/csv-api/?queryName=GetCannedQuarantineMsgs",success:function(data){statusManager.model.setQuarantineComments(data)}})},renderContestModerator:function($panel){var ibleData=Ibles.pageContext.ibleData;var contestModerator=new Ibles.views.AdminContestModerator({className:"admin-contest-moderator-container",model:new Ibles.models.PendingContestsModel({id:ibleData.id,pendingContests:ibleData.pendingInContests})});$panel.append(contestModerator.$el)},renderFlagsManager:function($panel){var ibleData=Ibles.pageContext.ibleData;var flagsManager=new Ibles.views.AdminFlagsManager({className:"admin-flags-manager-container",model:new Ibles.models.AdminFlagsModel({id:ibleData.id,flags:ibleData.flags})});$panel.append(flagsManager.$el)},renderAttributesPanel:function($panel){var ibleData=Ibles.pageContext.ibleData;var attributesPanel=new Ibles.views.AdminIbleAttributesPanel({className:"admin-attributes-panel-container",model:new Ibles.models.AdminIbleAttributesModel(_.extend({id:ibleData.id},_.pick(ibleData,"isApproved","pgFlag","sponsoredFlag","fullAccessFlag","commentingEnabled","pdfBackupMade")))});$panel.append(attributesPanel.$el)},renderReviewModule:function($panel){var ibleData=Ibles.pageContext.ibleData;var reviewPanel=new Ibles.views.AdminReviewModule({className:"admin-review-module-container",model:new Ibles.models.AdminReviewModel({id:ibleData.id,reviewState:ibleData.reviewState,reviewerScreenName:ibleData.reviewer&&ibleData.reviewer.screenName,reviewedDate:ibleData.reviewedDate})});
$panel.append(reviewPanel.$el)}});